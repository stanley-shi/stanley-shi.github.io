---
layout: post
title: TeraSort tuning
date: '2014-01-06T15:21:00.002+08:00'
author: Stanley Shi
tags: 
modified_time: '2014-01-06T15:21:45.208+08:00'
blogger_id: tag:blogger.com,1999:blog-4195205503550406237.post-331049718133746090
blogger_orig_url: http://eng-architect.blogspot.com/2014/01/terasort-tuning.html
---

<h3 id="TeraSortperformancetuningonCiscoCluster-Hardware" style="-webkit-text-stroke-width: 0px; background-color: white; color: black; font-family: Arial, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; letter-spacing: normal; line-height: 1.5625; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><span style="font-size: small;"><span style="font-weight: normal;">I have done a performance tuning on a 13 node cluster recently for running TeraSort. Here're some findings. </span></span></h3><h3 id="TeraSortperformancetuningonCiscoCluster-Hardware" style="-webkit-text-stroke-width: 0px; background-color: white; color: black; font-family: Arial, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; letter-spacing: normal; line-height: 1.5625; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Hardware</h3><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">The environment has 16 servers in total;&nbsp;</div><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">The specification of each node:</div><ol style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; list-style-type: decimal; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><li>CPU: 2 * 8 Core CPU, with HT enabled; total 32 cores</li><li>Disk: 12 * 2T Disk in total;<ol style="list-style-type: lower-alpha; margin: 0px;"><li>the first disk is spitted into 2 partition (100G + others), 100G used as system partition, others mounted as separate folder;</li><li>11 other disks are mounted separately</li></ol></li><li>Mem: 16 * 8G memory; total 128 G;</li></ol><h3 id="TeraSortperformancetuningonCiscoCluster-Clusterconfiguration" style="-webkit-text-stroke-width: 0px; background-color: white; color: black; font-family: Arial, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; letter-spacing: normal; line-height: 1.5625; margin: 30px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Cluster configuration</h3><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">1 node used as ResourceManager/NameNode, 12 ndoes used as NodeManager/DataNode;</div><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">NodeManager allocates 120G as total resource (originally only allocates 8G);</div><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">DataNode uses the 11 separately mounted disk as working folder;</div><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Mapreduce uses the 11 separately mounted disk as working folder;</div><h2 id="TeraSortperformancetuningonCiscoCluster-Originalstatus" style="-webkit-text-stroke-width: 0px; background-color: white; border-bottom-color: rgb(46, 61, 84); color: black; font-family: Arial, sans-serif; font-size: 20px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 1.5; margin: 30px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Original status</h2><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">300 GB data &nbsp;running at about 20 minutes;</div><h2 id="TeraSortperformancetuningonCiscoCluster-FinalStatus" style="-webkit-text-stroke-width: 0px; background-color: white; border-bottom-color: rgb(46, 61, 84); color: black; font-family: Arial, sans-serif; font-size: 20px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 1.5; margin: 30px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Final Status</h2><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">700 GB data sorted in 11 - 12 minutes.</div><h2 id="TeraSortperformancetuningonCiscoCluster-Findings" style="-webkit-text-stroke-width: 0px; background-color: white; border-bottom-color: rgb(46, 61, 84); color: black; font-family: Arial, sans-serif; font-size: 20px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 1.5; margin: 30px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Findings</h2><div style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Note: here the findings may be specific to the TeraSort benchmark in this specific scenario.</div><ol style="-webkit-text-stroke-width: 0px; background-color: white; color: #333333; font-family: Arial, sans-serif; font-size: 14.399999618530273px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 16px; list-style-type: decimal; margin: 10px 0px 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><li>Make sure all data can fit in memory at reduce phase. Spilling data onto disk will decrease the reducer performance.<ol style="list-style-type: lower-alpha; margin: 0px;"><li>We have total 120G * 12 = 1.44 TB memory, considering some overhead of the JVM and system memory usage, 1 TB data cannot be fully fit in to the memory, so at last we get to sort 700GB data in this environment.</li><li>To achieve this, we set the&nbsp;mapreduce.reduce.memory.mb to higher value (8192);</li></ol></li><li>Use the memory requirement to control how many map/reduce tasks can be ran at the same time; for example<ol style="list-style-type: lower-alpha; margin: 0px;"><li>for map, set the value&nbsp;mapreduce.map.memory.mb to 4G will let the MR to run at most 30 (120G/4G=30) map task on each node at the same time;</li><li>for reduce, set the value&nbsp;mapreduce.reduce.memory.mb to 8G will let the MR to run at most 15 (120G/8G=15) map task on each node at the same time;</li></ol></li><li>Aside from the above &nbsp;mb values, you have to also set mapreduce.map.java.opts/mapreduce.reduce.java.opts to tell the child java process to use more memory than default value;</li><li>When tasks are running with large JVM memory, GC will be a big issue;<ol style="list-style-type: lower-alpha; margin: 0px;"><li>During our tuning, we always facing the problem of reduce task timeout after 600 ms and the NodeManager thought it was dead and killed it; this is due to heavy GC is undergoing;</li><li>The other issue is that the default GC strategy(-XX:+UseParallelGC) will start as many threads as the number of the CPU cores; in terasort case, each reduce task will start 32 thread for GC; use&nbsp;<em>-XX:ParallelGCThreads=n<span class="Apple-converted-space">&nbsp;</span></em>to set it to smaller value;</li><li>GC strategy should also be considered; in TeraSort case, data will not be discarded until the last phase;<ol style="list-style-type: lower-roman; margin: 0px;"><li>The data-size is pretty large and each task will have only one or two processors on average;</li><li>It's recommended to enable<span class="Apple-converted-space">&nbsp;</span><strong>incremental mode</strong><span class="Apple-converted-space">&nbsp;</span>for the concurrent collector (<span style="color: #666666;">-XX:+UseConcMarkSweepGC)&nbsp;</span></li></ol></li></ol></li><li>In MapReduce code, the InMemoryMerger behaves strange<ol style="list-style-type: lower-alpha; margin: 0px;"><li>If the data can be put in memory, it works good;</li><li>if only 95% of the data can be put in memory, it will spill<span class="Apple-converted-space">&nbsp;</span><strong>all data</strong><span class="Apple-converted-space">&nbsp;</span>to disk before the last merge;</li><li>This is also part of reason of the above #1</li></ol></li><li><a class="external-link" href="https://issues.apache.org/jira/browse/MAPREDUCE-5649" rel="nofollow" style="color: #326ca6; text-decoration: none;">MAPREDUCE-5649</a><span class="Apple-converted-space">&nbsp;</span>is filed. We changed this part of code and re-compiled the code to use more than 2G data;<br /><ol style="list-style-type: lower-alpha; margin: 0px;"><li>If this code is not changed, we had better to make sure each reducer processes less than 2GB data;</li></ol></li><li>Reducer number should be the same as the number of CPU cores ( or similar)<ol style="list-style-type: lower-alpha; margin: 0px;"><li>Since all data are put in memory, no need to consider disk numbers;</li><li>Reducer number can be controlled by&nbsp;mapreduce.reduce.memory.mb</li></ol></li><li>For CPU efficiency consideration<ol style="list-style-type: lower-alpha; margin: 0px;"><li>If CPU usage too high, normally we should reduce the concurrent task numbers (increase memory usage)</li><li>If CPU usage too low, we should increate the concurrent task numbers;</li></ol></li><li>mapreduce.map.java.opts should be used to controll the child java process; this value not be a little less (300-400MB) than the value&nbsp;mapreduce.map.memory.mb;<ol style="list-style-type: lower-alpha; margin: 0px;"><li>similar to the param&nbsp;mapreduce.reduce.java.opts;</li></ol></li><li>In order to sort all data in memory for each map task,&nbsp;<ol style="list-style-type: lower-alpha; margin: 0px;"><li>the value&nbsp;mapreduce.task.io.sort.mb should be larger than block size;</li><li>mapreduce.map.sort.spill.percent should also be used together with the one above;</li></ol></li><li><span style="font-size: 14px; line-height: 1.4285715;">In the reducer side, the following params should be considered</span><br /><ol style="list-style-type: lower-alpha; margin: 0px;"><li><span style="font-size: 14px; line-height: 1.4285715;">mapreduce.reduce.shuffle.parallelcopies (default 5) this value should be increased if the system cpu wait time is not too high;</span></li><li><span style="font-size: 14px; line-height: 1.4285715;">mapreduce.reduce.shuffle.input.buffer.percent should be increased if data size is big;</span></li><li><span style="font-size: 14px; line-height: 1.4285715;">mapreduce.reduce.shuffle.merge.percent and&nbsp;mapreduce.reduce.shuffle.input.buffer.percent should be used to increase memory allocation;</span></li></ol></li></ol>